# 座席抽選システム (Seat Lottery)

100%フロントエンド（ブラウザ完結）の座席抽選システムです。受付タブレット1台でのキオスク運用を想定しています。

## 特徴

- **100%フロントエンド**: サーバー不要、ブラウザのみで動作
- **キオスク運用対応**: タブレット向けの大きなボタンとタッチ操作
- **リアルタイム座席表**: ズーム/パン対応の視覚的な座席表
- **公平な抽選**: 連番優先→近接クラスタの抽選アルゴリズム
- **永続化**: localStorage による状態保持、リロード対応

## ファイル構成

```
seat-lottery/
├── index.html              # 来場者画面（抽選メイン画面）
├── admin.html              # 管理画面（設定・レイアウト編集）
├── js/
│   ├── store.js            # 状態管理・抽選ロジック
│   ├── SeatMapViewer.js    # 座席表示コンポーネント
│   ├── app.js              # 来場者画面ロジック
│   └── admin.js            # 管理画面ロジック
├── css/
│   └── style.css           # 全体スタイル
└── README.md               # このファイル
```

## セットアップ手順

### 1. ファイル配置
```bash
# Webサーバーのドキュメントルートに配置
cp -r seat-lottery/ /path/to/webroot/
```

### 2. Webサーバー起動
```bash
# Python 3の場合
cd seat-lottery
python -m http.server 8080

# Node.jsの場合（npx serve）
npx serve -s . -l 8080
```

### 3. ブラウザでアクセス
- 来場者画面: `http://localhost:8080/`
- 管理画面: `http://localhost:8080/admin.html`

## 運用手順

### 事前準備（管理画面）

1. **レイアウト設定**
   - 行数・列数を設定
   - セルをクリック/ドラッグで種別変更（座席→通路→ブロック）

2. **番号付け設定**
   - 方式: 行優先/蛇腹/列優先
   - 行ラベル: 英字/数字/ひらがな
   - ゼロ埋め桁数、ステージ位置

3. **抽選設定**
   - 最大グループ人数（1〜20）
   - 厳密連番モード（連番がない場合の確認）
   - PINロック（4桁、オプション）

4. **プリセット保存**
   - 設定をJSONでエクスポート/インポート可能

### キオスク運用開始

1. **フルスクリーンモード**
   ```
   F11キー: フルスクリーン切り替え
   ESCキー: 解除阻止（キオスクモード）
   ```

2. **スリープ防止**
   - Wake Lock APIによる自動スリープ防止
   - タブレットの設定で画面タイムアウトを無効化推奨

3. **来場者画面での抽選**
   - 人数選択（1〜設定した最大人数）
   - 抽選ボタン押下
   - 結果表示（座席番号を大きく表示）
   - 座席表でのハイライト表示

## 抽選アルゴリズム

### 1. 連番探索（優先）
- 同一行で指定人数分の連続座席を全探索
- 複数候補がある場合は等確率でランダム選択

### 2. 近接クラスタ（連番不可時）
- マンハッタン距離の総和が最小となる座席組み合わせを選択
- 同率の場合はランダム選択

### 3. 厳密連番モード
- 連番がない場合、「近い席でOK？」の確認ダイアログを表示

## 動作確認手順

### 基本機能テスト

1. **レイアウト編集テスト**
   ```
   管理画面 → レイアウト設定 → 5×5で設定 → 適用
   セルクリックで座席→通路→ブロック切り替え確認
   ```

2. **番号付けテスト**
   ```
   番号付け方式を「蛇腹」に変更 → 適用
   座席表で番号表示が正しいことを確認
   ```

3. **抽選テスト**
   ```
   来場者画面 → 2人選択 → 抽選実行
   結果表示と座席表ハイライト確認
   残席カウンタの減少確認
   ```

4. **永続化テスト**
   ```
   座席使用後にブラウザリロード
   状態が復元されることを確認
   ```

### エラーハンドリングテスト

1. **満席テスト**
   ```
   小さいレイアウト（2×2）で全座席を使用
   満席メッセージの表示確認
   ```

2. **残席不足テスト**
   ```
   残席3席で4人抽選を試行
   エラーメッセージ表示確認
   ```

3. **厳密連番モード**
   ```
   厳密連番モードON、連番不可の状況で抽選
   確認ダイアログの動作確認
   ```

## トラブルシューティング

### 座席が重複配布される
- **原因**: JavaScriptエラーまたはlocalStorage破損
- **対処**: ブラウザの開発者ツールでエラー確認、localStorageクリア

### 画面が正しく表示されない
- **原因**: CSSファイル読み込み失敗
- **対処**: ブラウザキャッシュクリア、Webサーバー再起動

### タッチ操作が効かない
- **原因**: ブラウザのタッチイベント未対応
- **対処**: モダンブラウザ（Chrome/Safari/Firefox）を使用

### スリープ防止が効かない
- **原因**: Wake Lock API未対応またはHTTPS必須
- **対処**: HTTPS環境で運用、またはタブレット設定で無効化

## ブラウザ対応

### 推奨ブラウザ
- Chrome 80+
- Safari 13+
- Firefox 75+
- Edge 80+

### 必要機能
- localStorage
- Canvas API
- Touch Events
- Wake Lock API（スリープ防止、オプション）

## 運用tips

### タブレット設定
```
画面の明るさ: 最大
画面タイムアウト: なし
自動回転: ロック（横画面推奨）
通知: 無効
```

### フルスクリーンキオスク
```
Chrome起動オプション:
chrome --kiosk --disable-session-crashed-bubble --disable-infobars
```

### データバックアップ
```javascript
// 管理画面でコンソール実行
localStorage.getItem('seat-lottery') // 設定データ取得
```

## 今後の拡張予定

- [ ] CSV入出力機能
- [ ] PIN強化（管理画面ロック）
- [ ] 抽選アニメーション
- [ ] 抽選シード表示
- [ ] 利用統計
- [ ] 複数会場対応

## ライセンス

MIT License

## Google Analytics 4 (GA4) 確認手順

### DebugView での確認方法

1. **GA4プロパティ** → **DebugView** にアクセス
2. **測定ID**: `G-EHJMXX4TW2`
3. **確認項目**:
   - `page_view`: 各画面遷移時に送信
   - `draw`: 抽選実行時（group_size, assigned_count, contiguous, remaining）
   - `reset`: 新しい抽選ボタン押下時
   - `layout_save`: レイアウト保存時（rows, cols, total_seats）
   - `layout_load`: プリセット読み込み時（source: file_import/text_input）

### 計測パス
- メニュー画面: `/` または `/index.html`
- 座席抽選画面: `/lottery.html`
- 管理画面: `/admin.html`

### プライバシーポリシー
利用状況分析のためGoogle Analytics 4を使用しています。  
詳細は [プライバシーポリシー](privacy.html) をご参照ください。

## 更新履歴

- v1.1.0: GA4分析機能追加
  - Google Analytics 4統合
  - カスタムイベント計測
  - SPA対応ページビュー送信
- v1.0.0: 初回リリース
  - 基本的な座席抽選機能
  - キオスク運用対応
  - 管理画面による設定機能